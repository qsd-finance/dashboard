{"ast":null,"code":"import _regeneratorRuntime from\"/Users/J/crypto/dashboard/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _slicedToArray from\"/Users/J/crypto/dashboard/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _asyncToGenerator from\"/Users/J/crypto/dashboard/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import React,{useEffect,useState}from'react';import{useHistory}from'react-router-dom';import{Button,IconRight,DataView,useTheme}from'@aragon/ui';import{getAllProposals,getApproveFor,getEpoch,getIsInitialized,getRejectFor,getTokenTotalSupply,getTotalBondedAt}from'../../utils/infura';import{QSDS}from'../../constants/tokens';import{AddressBlock}from'../common';import{proposalStatus}from'../../utils/gov';import BigNumber from'bignumber.js';function formatProposals(_x,_x2){return _formatProposals.apply(this,arguments);}function _formatProposals(){_formatProposals=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(epoch,proposals){var currentTotalStake,initializeds,approves,rejecteds,supplyAts,i;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return getTokenTotalSupply(QSDS.addr);case 2:currentTotalStake=_context3.sent;_context3.next=5;return Promise.all(proposals.map(function(p){return getIsInitialized(QSDS.addr,p.candidate);}));case 5:initializeds=_context3.sent;_context3.next=8;return Promise.all(proposals.map(function(p){return getApproveFor(QSDS.addr,p.candidate);}));case 8:approves=_context3.sent;_context3.next=11;return Promise.all(proposals.map(function(p){return getRejectFor(QSDS.addr,p.candidate);}));case 11:rejecteds=_context3.sent;_context3.next=14;return Promise.all(proposals.map(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(p){var at;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:at=p.start+p.period-1;if(!(epoch>at)){_context2.next=5;break;}_context2.next=4;return getTotalBondedAt(QSDS.addr,at);case 4:return _context2.abrupt(\"return\",_context2.sent);case 5:return _context2.abrupt(\"return\",currentTotalStake);case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x3){return _ref2.apply(this,arguments);};}()));case 14:supplyAts=_context3.sent;for(i=0;i<proposals.length;i++){proposals[i].index=proposals.length-i;proposals[i].start=parseInt(proposals[i].start);proposals[i].period=parseInt(proposals[i].period);proposals[i].status=proposalStatus(epoch,proposals[i].start,proposals[i].period,initializeds[i],new BigNumber(approves[i]),new BigNumber(rejecteds[i]),new BigNumber(supplyAts[i]));}return _context3.abrupt(\"return\",proposals);case 17:case\"end\":return _context3.stop();}}},_callee3);}));return _formatProposals.apply(this,arguments);}function CandidateHistory(_ref){var user=_ref.user;var theme=useTheme();var isDark=theme._name==='dark';var history=useHistory();var _useState=useState([]),_useState2=_slicedToArray(_useState,2),proposals=_useState2[0],setProposals=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),page=_useState4[0],setPage=_useState4[1];var _useState5=useState(false),_useState6=_slicedToArray(_useState5,2),initialized=_useState6[0],setInitialized=_useState6[1];useEffect(function(){var isCancelled=false;function updateUserInfo(){return _updateUserInfo.apply(this,arguments);}function _updateUserInfo(){_updateUserInfo=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _yield$Promise$all,_yield$Promise$all2,epochStr,allProposals,formattedProposals;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return Promise.all([getEpoch(QSDS.addr),getAllProposals(QSDS.addr)]);case 2:_yield$Promise$all=_context.sent;_yield$Promise$all2=_slicedToArray(_yield$Promise$all,2);epochStr=_yield$Promise$all2[0];allProposals=_yield$Promise$all2[1];if(isCancelled){_context.next=12;break;}_context.next=9;return formatProposals(parseInt(epochStr),allProposals);case 9:formattedProposals=_context.sent;setProposals(formattedProposals);setInitialized(true);case 12:case\"end\":return _context.stop();}}},_callee);}));return _updateUserInfo.apply(this,arguments);}updateUserInfo();var id=setInterval(updateUserInfo,15000);// eslint-disable-next-line consistent-return\nreturn function(){isCancelled=true;clearInterval(id);};},[user]);return/*#__PURE__*/React.createElement(\"div\",{className:isDark?'table-container-dark':undefined},/*#__PURE__*/React.createElement(DataView,{fields:['Proposal','Candidate','Proposed','Complete','Proposer','Status',''],status:initialized?'default':'loading'// @ts-ignore\n,entries:proposals,entriesPerPage:10,page:page,onPageChange:setPage,renderEntry:function renderEntry(proposal){return['#'+proposal.index,/*#__PURE__*/React.createElement(AddressBlock,{label:\"\",address:proposal.candidate}),proposal.start.toString(),(proposal.start+proposal.period).toString(),/*#__PURE__*/React.createElement(AddressBlock,{label:\"\",address:proposal.account}),proposal.status,/*#__PURE__*/React.createElement(Button,{wide:true,icon:/*#__PURE__*/React.createElement(IconRight,null),label:\"Go To\",onClick:function onClick(){history.push(\"/governance/candidate/\".concat(proposal.candidate));}})];}}));}export default CandidateHistory;","map":{"version":3,"sources":["/Users/J/crypto/dashboard/src/components/Governance/CandidateHistory.tsx"],"names":["React","useEffect","useState","useHistory","Button","IconRight","DataView","useTheme","getAllProposals","getApproveFor","getEpoch","getIsInitialized","getRejectFor","getTokenTotalSupply","getTotalBondedAt","QSDS","AddressBlock","proposalStatus","BigNumber","formatProposals","epoch","proposals","addr","currentTotalStake","Promise","all","map","p","candidate","initializeds","approves","rejecteds","at","start","period","supplyAts","i","length","index","parseInt","status","CandidateHistory","user","theme","isDark","_name","history","setProposals","page","setPage","initialized","setInitialized","isCancelled","updateUserInfo","epochStr","allProposals","formattedProposals","id","setInterval","clearInterval","undefined","proposal","toString","account","push"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { useHistory } from 'react-router-dom';\nimport { Button, IconRight, DataView, useTheme } from '@aragon/ui';\n\nimport {\n  getAllProposals,\n  getApproveFor,\n  getEpoch,\n  getIsInitialized,\n  getRejectFor,\n  getTokenTotalSupply,\n  getTotalBondedAt,\n} from '../../utils/infura';\nimport { QSDS } from '../../constants/tokens';\nimport { AddressBlock } from '../common';\nimport { proposalStatus } from '../../utils/gov';\nimport BigNumber from 'bignumber.js';\n\ntype CandidateHistoryProps = {\n  user: string;\n};\n\ntype Proposal = {\n  index: number;\n  candidate: string;\n  account: string;\n  start: number;\n  period: number;\n  status: string;\n};\n\nasync function formatProposals(\n  epoch: number,\n  proposals: any[]\n): Promise<Proposal[]> {\n\n  const currentTotalStake = await getTokenTotalSupply(QSDS.addr);\n  const initializeds = await Promise.all(\n    proposals.map((p) => getIsInitialized(QSDS.addr, p.candidate))\n  );\n  const approves = await Promise.all(\n    proposals.map((p) => getApproveFor(QSDS.addr, p.candidate))\n  );\n  const rejecteds = await Promise.all(\n    proposals.map((p) => getRejectFor(QSDS.addr, p.candidate))\n  );\n  const supplyAts = await Promise.all(\n    proposals.map(async (p) => {\n      const at = p.start + p.period - 1;\n      if (epoch > at) {\n        return await getTotalBondedAt(QSDS.addr, at);\n      }\n      return currentTotalStake;\n    })\n  );\n\n  for (let i = 0; i < proposals.length; i++) {\n    proposals[i].index = proposals.length - i;\n    proposals[i].start = parseInt(proposals[i].start);\n    proposals[i].period = parseInt(proposals[i].period);\n    proposals[i].status = proposalStatus(\n      epoch,\n      proposals[i].start,\n      proposals[i].period,\n      initializeds[i],\n      new BigNumber(approves[i]),\n      new BigNumber(rejecteds[i]),\n      new BigNumber(supplyAts[i])\n    );\n  }\n  return proposals;\n}\n\nfunction CandidateHistory({ user }: CandidateHistoryProps) {\n  const theme = useTheme();\n  const isDark = theme._name === 'dark';\n  const history = useHistory();\n  const [proposals, setProposals] = useState<Proposal[]>([]);\n  const [page, setPage] = useState(0);\n  const [initialized, setInitialized] = useState(false);\n\n  useEffect(() => {\n    let isCancelled = false;\n\n    async function updateUserInfo() {\n      const [epochStr, allProposals] = await Promise.all([\n        getEpoch(QSDS.addr),\n        getAllProposals(QSDS.addr),\n      ]);\n\n      if (!isCancelled) {\n        const formattedProposals = await formatProposals(\n          parseInt(epochStr),\n          allProposals\n        );\n        setProposals(formattedProposals);\n        setInitialized(true);\n      }\n    }\n    updateUserInfo();\n    const id = setInterval(updateUserInfo, 15000);\n\n    // eslint-disable-next-line consistent-return\n    return () => {\n      isCancelled = true;\n      clearInterval(id);\n    };\n  }, [user]);\n\n  return (\n    <div className={isDark ? 'table-container-dark' : undefined}>\n      <DataView\n        fields={[\n          'Proposal',\n          'Candidate',\n          'Proposed',\n          'Complete',\n          'Proposer',\n          'Status',\n          '',\n        ]}\n        status={initialized ? 'default' : 'loading'}\n        // @ts-ignore\n        entries={proposals}\n        entriesPerPage={10}\n        page={page}\n        onPageChange={setPage}\n        renderEntry={(proposal) => [\n          '#' + proposal.index,\n          <AddressBlock label='' address={proposal.candidate} />,\n          proposal.start.toString(),\n          (proposal.start + proposal.period).toString(),\n          <AddressBlock label='' address={proposal.account} />,\n          proposal.status,\n          <Button\n            wide\n            icon={<IconRight />}\n            label='Go To'\n            onClick={() => {\n              history.push(`/governance/candidate/${proposal.candidate}`);\n            }}\n          />,\n        ]}\n      />\n    </div>\n  );\n}\n\nexport default CandidateHistory;\n"]},"metadata":{},"sourceType":"module"}